<ion-header [translucent]="true" class="store-seller-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard-seller"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ store[0]?.store_name || 'Store Detail' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="store-seller-content">

  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Pull to refresh"
      refreshingSpinner="circles"
      refreshingText="Refreshing...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- STORE CARD -->
  <ion-card *ngIf="store?.length" class="store-card">

    <!-- STORE HEADER -->
    <ion-card-header>
      <ion-card-title>
        <div class="store-title-wrapper">
          <!-- <span>{{ store[0]?.store_name }}</span> -->
          <ion-input
            type="text"
            [(ngModel)]="store[0].store_name"
            [readonly]="editingStoreId !== store[0].store_id"
            placeholder="Edit Store Name">
          </ion-input>
        </div>
      </ion-card-title>
    </ion-card-header>

    <!-- STORE IMAGE -->
    <div class="store-image">
      <ion-img
        *ngIf="store[0]?.store_image_path"
        [src]="environment.Upload_URL + '/' + store[0].store_image_path">
      </ion-img>
    </div>

    <ion-card-content>
      <!-- <p><strong>Store ID:</strong> {{ store[0]?.store_id }}</p>
      <p><strong>Seller ID:</strong> {{ store[0]?.seller_id }}</p> -->
      <!-- <p>
        <strong>Location:</strong>
        <ion-input
          type="number"
          [(ngModel)]="store[0].latitude"
          [readonly]="editingStoreId !== store[0].store_id">
        </ion-input>,
        <ion-input
          type="number"
          [(ngModel)]="store[0].longitude"
          [readonly]="editingStoreId !== store[0].store_id">
        </ion-input>
      </p> -->
      <p class="location-row">
        <strong>Location:</strong>

        <ion-input
          type="number"
          [(ngModel)]="store[0].latitude"
          [readonly]="editingStoreId !== store[0].store_id">
        </ion-input>

        <span>,</span>

        <ion-input
          type="number"
          [(ngModel)]="store[0].longitude"
          [readonly]="editingStoreId !== store[0].store_id">
        </ion-input>
      </p>


      <ion-item *ngIf="editingStoreId === store[0].store_id">
        <input type="file" accept="image/*" (change)="onStoreImageSelected($event)">
      </ion-item>

      <ion-button expand="block" (click)="toggleStoreEdit(store[0])">
        {{ editingStoreId === store[0].store_id ? 'Save' : 'Edit' }}
      </ion-button>
    </ion-card-content>

    <!-- STOCK LIST -->
    <ion-card-content *ngFor="let s of store" class="stock-card">

      <div class="stock-image">
        <ion-img *ngIf="s.store_stock_image_path"
                 [src]="environment.Upload_URL + s.store_stock_image_path"
                 alt="{{ s.stock_name }}">
        </ion-img>
      </div>

      <!-- <h3>{{ s.stock_name }}</h3> -->
      <p><strong>Stock Name:</strong></p>

      <!-- <ion-input
        placeholder="Stock Name"
        [(ngModel)]="s.stock_name"
        [readonly]="editingStockId !== s.stock_id">
      </ion-input> -->

      <ion-input
        placeholder="Stock Name"
        [(ngModel)]="s.stock_name"
        (ionInput)="filterStocks($event)"
        [readonly]="editingStockId !== s.stock_id">
      </ion-input>

      <ion-list *ngIf="filteredStocks.length && editingStockId === s.stock_id">
        <ion-item
          button
          *ngFor="let stock of filteredStocks"
          (click)="selectStock(stock, s)">
          {{ stock.stock_name }}
        </ion-item>
      </ion-list>

      <p><strong>Category Name:</strong></p>
      <ion-input
        placeholder="Category Name"
        [(ngModel)]="s.category_name"
        (ionInput)="filterCategories($event)"
        [readonly]="editingStockId !== s.stock_id">
      </ion-input>

      <ion-list *ngIf="filteredCategories.length && editingStockId === s.stock_id">
        <ion-item
          button
          *ngFor="let category of filteredCategories"
          (click)="selectCategory(category, s)">
          {{ category.category_name }}
        </ion-item>
      </ion-list>
      

      <!-- <ion-input
        placeholder="Category Name"
        [(ngModel)]="s.category_name"
        [readonly]="editingStockId !== s.stock_id">
      </ion-input> -->

      <p><strong>Price:</strong> RM {{ s.price }}</p>
      <ion-input type="number" inputmode="decimal" step="0.01" min="0" [(ngModel)]="s.price" [readonly]="editingStockId !== s.stock_id"></ion-input>

      <p><strong>Quantity:</strong> {{ s.quantity }}</p>
      <ion-input type="number" inputmode="numeric" step="1" min="0" [(ngModel)]="s.quantity" [readonly]="editingStockId !== s.stock_id"></ion-input>

      <p><strong>Description:</strong></p>
      <ion-input [(ngModel)]="s.description" [readonly]="editingStockId !== s.stock_id"></ion-input>

      <ion-item *ngIf="editingStockId === s.stock_id">
        <input type="file" accept="image/*" (change)="onStockImageSelected($event)">
      </ion-item>

      <ion-button *ngIf="editingStockId === s.stock_id" fill="clear" color="danger" size="small" (click)="deleteStock(s.stock_id)">
        Remove
      </ion-button>

      <ion-button expand="block" (click)="toggleEdit(s)">
        {{ editingStockId === s.stock_id ? 'Save' : 'Edit' }}
      </ion-button>

    </ion-card-content>

    
  </ion-card>
  <!-- ADD NEW STOCK -->
  <ion-button expand="block" color="success" (click)="showAddStock = !showAddStock">
    âž• Add New Stock
  </ion-button>

  <ion-card *ngIf="showAddStock" class="add-stock-card">
    <ion-card-header>
      <ion-card-title>Add New Stock</ion-card-title>
    </ion-card-header>

    <ion-card-content>
      <!-- <ion-input placeholder="Stock Name" [(ngModel)]="newStock.stock_name"></ion-input> -->

      <ion-input
        placeholder="Stock Name"
        [(ngModel)]="newStock.stock_name"
        (ionInput)="filterStocks($event)">
      </ion-input>


      <ion-list *ngIf="filteredStocks.length">
        <ion-item
          button
          *ngFor="let stock of filteredStocks"
          (click)="selectNewStock(stock)">
          {{ stock.stock_name }}
        </ion-item>
      </ion-list>

      <p><strong>Category Name:</strong></p>
      <ion-input
        placeholder="Category Name"
        [(ngModel)]="newStock.category_name"
        (ionInput)="filterCategories($event)">
      </ion-input>

      <ion-list *ngIf="filteredCategories.length">
        <ion-item
          button
          *ngFor="let category of filteredCategories"
          (click)="selectNewCategory(category)">
          {{ category.category_name }}
        </ion-item>
      </ion-list>
      
      <ion-input type="number" placeholder="Price" [(ngModel)]="newStock.price"></ion-input>
      <ion-input type="number" placeholder="Quantity" [(ngModel)]="newStock.quantity"></ion-input>
      <ion-input placeholder="Description" [(ngModel)]="newStock.description"></ion-input>

      <ion-item>
        <input type="file" accept="image/*" (change)="onStockImageSelected($event)">
      </ion-item>

      <ion-button expand="block" color="primary" (click)="addStock()">Save Stock</ion-button>
    </ion-card-content>
  </ion-card>
  
  <ion-button expand="block" color="tertiary" (click)="navigateToStore()">
    Navigate to Store
  </ion-button>

</ion-content>
